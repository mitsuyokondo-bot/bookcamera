<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>バーコード蔵書管理アプリ</title>
  
  <!-- Tailwind CSS（Play CDN） -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- QuaggaJS（CDNJS） + SRI -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.js"
    integrity="sha512-bCsBoYoW6zE0aja5xcIyoCDPfT27+cGr7AOCqelttLVRGay6EKGQbR6wm6SUcUGOMGXJpj+jrIpMS6i80+kZPw=="
    crossorigin="anonymous">
  </script>

  <!-- カメラ映像の表示崩れを直すCSS -->
  <style>
    #video-container {
      position: relative;
    }
    #video-container video,
    #video-container canvas {
      width: 100% !important;
      height: 100% !important;
      object-fit: contain !important;
      position: absolute;
      top: 0;
      left: 0;
    }
  </style>
</head>

<body class="bg-slate-100 min-h-screen">
  <div class="max-w-5xl mx-auto px-4 py-6">
    
    <!-- Header -->
    <header class="mb-6 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">バーコード蔵書管理アプリ</h1>
        <p class="text-sm text-slate-600 mt-1">
          カメラで本のバーコード（ISBN）を読み取り、タイトル・著者・出版社・出版日を一覧管理します。
        </p>
      </div>
      <div class="text-xs text-slate-500">※カメラ利用のため、HTTPS または localhost を推奨</div>
    </header>

    <div class="grid gap-6 md:grid-cols-[minmax(0,1.2fr)_minmax(0,2fr)]">
      
      <!-- Camera Section -->
      <section class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-4">
        <h2 class="text-lg font-semibold text-slate-800 mb-1">カメラ & バーコード読み取り</h2>

        <div id="video-container"
             class="bg-black/80 rounded-xl overflow-hidden w-full max-w-sm h-56 mx-auto flex items-center justify-center text-slate-300 text-sm">
          カメラを起動するとここにプレビューが表示されます
        </div>

        <div class="flex gap-3 justify-center mt-1">
          <button id="start-btn"
                  class="px-4 py-2 rounded-full text-sm font-medium bg-emerald-500 text-white hover:bg-emerald-600 transition">
            カメラ起動
          </button>
          <button id="stop-btn"
                  class="px-4 py-2 rounded-full text-sm font-medium bg-slate-200 text-slate-800 hover:bg-slate-300 transition">
            カメラ停止
          </button>
        </div>

        <div class="mt-2 text-xs text-slate-500 leading-relaxed">
          ・ISBNバーコード（13桁・先頭978/979）を読み取ります。<br>
          ・Google Books API を利用して書籍情報を取得します。<br>
          ・同じ本を連続で読み取らないように制御しています。
        </div>

        <div id="status" class="mt-2 text-xs text-slate-500">
          ステータス: <span class="font-medium" id="status-text">待機中</span>
        </div>
      </section>

      <!-- Book List Section -->
      <section class="bg-white rounded-2xl shadow-sm p-4 flex flex-col">
        <div class="flex items-center justify-between mb-3 gap-3">
          <div>
            <h2 class="text-lg font-semibold text-slate-800">読み取り済み書籍リスト</h2>
            <p class="text-xs text-slate-500">
              最新の登録が一番上に表示されます。
            </p>
          </div>
          <div class="flex items-center gap-2">
            <button id="export-csv-btn"
                    class="px-3 py-1.5 rounded-full text-xs font-medium bg-sky-50 text-sky-700 hover:bg-sky-100 transition">
              CSV出力
            </button>
            <button id="clear-all-btn"
                    class="px-3 py-1.5 rounded-full text-xs font-medium bg-rose-50 text-rose-600 hover:bg-rose-100 transition">
              全件削除
            </button>
          </div>
        </div>

        <div id="empty-message"
             class="flex-1 flex items-center justify-center text-sm text-slate-400 border border-dashed border-slate-200 rounded-xl py-8">
          まだ書籍が登録されていません。
        </div>

        <ul id="book-list" class="space-y-3 hidden overflow-y-auto max-h-[70vh] pr-1 text-sm"></ul>
      </section>

    </div>
  </div>

  <!-- Main Script -->
  <script>
    const STORAGE_KEY = 'bookScannerCollection';
    let books = [];
    let scannerActive = false;
    let lastScan = { code: null, time: 0 };

    const statusTextEl = document.getElementById('status-text');
    const bookListEl = document.getElementById('book-list');
    const emptyMessageEl = document.getElementById('empty-message');

    /*------------------------------------------------
      localStorage 読み込み・保存
    ------------------------------------------------*/
    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) books = JSON.parse(raw) || [];
      } catch {}
      renderBookList();
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(books));
    }

    function setStatus(msg) {
      statusTextEl.textContent = msg;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /*------------------------------------------------
      書籍リスト描画
    ------------------------------------------------*/
    function renderBookList() {
      if (!books.length) {
        emptyMessageEl.classList.remove('hidden');
        bookListEl.classList.add('hidden');
        bookListEl.innerHTML = '';
        return;
      }
      emptyMessageEl.classList.add('hidden');
      bookListEl.classList.remove('hidden');

      bookListEl.innerHTML = books.map((book, index) => `
        <li class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-3">
          <div class="flex justify-between">
            <div>
              <p class="font-semibold text-slate-900">${escapeHtml(book.title)}</p>
              <p class="text-xs text-slate-600">著者: ${escapeHtml(book.authors)}</p>
              <p class="text-xs text-slate-600">出版社: ${escapeHtml(book.publisher)}</p>
              <p class="text-xs text-slate-600">出版日: ${escapeHtml(book.publishedDate)}</p>
              <p class="text-xs text-slate-500">ISBN: <span class="font-mono">${escapeHtml(book.isbn)}</span></p>
            </div>
            <button
              class="px-2 py-1 rounded-full text-[11px] font-medium bg-rose-50 text-rose-600 hover:bg-rose-100 delete-btn"
              data-index="${index}">削除</button>
          </div>
        </li>
      `).join('');
    }

    /*------------------------------------------------
      書籍削除
    ------------------------------------------------*/
    bookListEl.addEventListener('click', (e) => {
      const btn = e.target.closest('.delete-btn');
      if (!btn) return;
      const idx = Number(btn.dataset.index);
      books.splice(idx, 1);
      saveToStorage();
      renderBookList();
    });

    document.getElementById('clear-all-btn').addEventListener('click', () => {
      if (!books.length) return;
      if (confirm("すべて削除しますか？")) {
        books = [];
        saveToStorage();
        renderBookList();
      }
    });

    /*------------------------------------------------
      CSV出力
    ------------------------------------------------*/
    document.getElementById('export-csv-btn').addEventListener('click', () => {
      if (!books.length) {
        alert("データがありません");
        return;
      }

      const toCell = (v) => `"${String(v ?? '').replace(/"/g, '""')}"`;

      const header = ['ISBN', 'タイトル', '著者', '出版社', '出版日', '登録日時'];
      const lines = [header.map(toCell).join(",")];

      books.forEach(b => {
        lines.push([
          toCell(b.isbn),
          toCell(b.title),
          toCell(b.authors),
          toCell(b.publisher),
          toCell(b.publishedDate),
          toCell(b.addedAt)
        ].join(","));
      });

      const csv = "\uFEFF" + lines.join("\r\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "books.csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    /*------------------------------------------------
      Quagga (Barcode Scan)
    ------------------------------------------------*/
    function startScanner() {
      if (scannerActive) return;

      setStatus("カメラ起動中…");

      Quagga.init({
        inputStream: {
          name: 'Live',
          type: 'LiveStream',
          target: document.querySelector('#video-container'),
          constraints: { facingMode: 'environment' }
        },
        decoder: { readers: ['ean_reader'] },
        locate: true
      }, (err) => {
        if (err) {
          setStatus("エラー");
          alert("カメラ起動に失敗しました");
          console.error(err);
          return;
        }
        Quagga.start();
        scannerActive = true;
        setStatus("バーコードをスキャンできます");
      });

      Quagga.onDetected(onDetected);
    }

    function stopScanner() {
      if (!scannerActive) return;
      Quagga.stop();
      scannerActive = false;
      setStatus("停止中");
    }

    async function onDetected(result) {
      const code = result?.codeResult?.code;
      if (!code) return;

      const now = Date.now();
      if (lastScan.code === code && now - lastScan.time < 3000) return;

      lastScan = { code, time: now };

      // ISBN-13形式チェック
      if (!/^\d{13}$/.test(code) || (!code.startsWith('978') && !code.startsWith('979'))) {
        return;
      }

      // 重複チェック
      if (books.some(b => b.isbn === code)) {
        setStatus(`すでに登録済み: ${code}`);
        return;
      }

      setStatus(`ISBN ${code} の情報取得中…`);

      try {
        const info = await fetchBookInfo(code);
        books.unshift(info);
        saveToStorage();
        renderBookList();
        setStatus("登録完了");
      } catch (e) {
        console.error(e);
        setStatus("情報取得失敗");
        alert("書籍情報の取得に失敗しました");
      }
    }

    /*------------------------------------------------
      Google Books API (出版社 / 出版日 含む)
    ------------------------------------------------*/
    async function fetchBookInfo(isbn) {
      const url = `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`;
      const res = await fetch(url);
      const data = await res.json();

      const info = data.items?.[0]?.volumeInfo ?? {};

      return {
        isbn,
        title: info.title ?? "タイトル不明",
        authors: info.authors?.join(", ") ?? "不明",
        publisher: info.publisher ?? "不明",
        publishedDate: info.publishedDate ?? "不明",
        addedAt: new Date().toISOString()
      };
    }

    document.getElementById('start-btn').addEventListener('click', startScanner);
    document.getElementById('stop-btn').addEventListener('click', stopScanner);

    loadFromStorage();
  </script>
</body>
</html>
